# 通信协议

## 物理

UART + SPP

## 数据链路层

```
| 起始符 | 数据包内容 | 结束符 |
```

- **起始符**：2 字节 0xAA 0x55
- **结束符**：2 字节 0x55 0xAA

对于数据中所有的 `0xAA` 与 `0x55` 字节，发送方应当进行转义处理：在其后填充一个 `0x00` 字节，接收方在解析时应当将 `0xAA00` 或 `0x5500` 组合还原为原始字节。

- 若数据中检测到 `0xAA00` 或 `0x5500`，则表示原始数据中为 `0xAA` 或 `0x55` 字节，接收方应当将其还原为原始字节。
- 若数据中检测到 `0xAA55` 或 `0x55AA`，则一定表示起始符或结束符，接收方应当直接使用。
- 若数据中检测到 `0xAA` 或 `0x55` 之后一个字节既不符合起始符或结束符，也不符合填充要求，则表示数据包损坏。

## 传输层

本节对前一节“数据链路层”的数据包内容进行详细定义。

```
版本（1B）| 类别 (1B) | 数据包编号 (2B) | 响应编号 (2B) | 数据长度 (2B) | 数据内容 (nB) | CRC32 (4B) | 
```

- **版本**：1 字节 表示当前协议版本，当前版本为 0x02。
- **类别**：1 字节
    - 0x00：主机到从机 请求
    - 0x01：主机到从机 响应
    - 0x0F：主机到从机 错误
    - 0x10：从机到主机 请求
    - 0x11：从机到主机 响应
    - 0x1F：从机到主机 错误
- **数据包编号**：2 字节，标识数据包的唯一性，建议使用自增的方式生成。
    - 范围为 0x00 ~ 0x7F, 0x80 ~ 0xFF，最高位标识数据包来源：
        - 0：主机发送
        - 1：从机发送
- **响应编号** 2 字节，仅在“响应”或“错误”类型的数据包有效，标识对应的原数据包编号。其他类型的数据包该字段应当设置为 0x00，接收方忽略此字段。
- **数据长度**：2 字节 实际数据的长度 $n (n \le 65535)$，不包含头部、尾部、校验和等信息。
- **数据**：$n$ 字节 实际数据内容
- **CRC32**：4 字节 CRC32 校验和，计算方式为对整个数据包内容（包含版本、数据长度、编号等字段，但不包含起始符、CRC32、结束符）进行 CRC32 计算
    - 注意：算法应与 STM32 硬件实现相同，而非标准 CRC32。

### 数据字段格式

所有数据字段均采用以下 TLV 格式：

```
| Tag (2B) | Length (2B) | Value (nB) |
```

- **Tag**：2 字符，仅允许 ASCII 可打印字符组合，大小写敏感（例如：`T ` 表示温度）
- **Length**：2 字节，无符号整数，表示 Value 部分长度
- **Value**：字段值，按具体含义解析，支持嵌套 TLV

### 错误响应

#### Data

错误响应包的格式与正常响应包类似，但类别为 0x0F 或 0x1F，数据部分包含错误码和可选的错误描述。

| Tag  | 类型     | 说明                 |
| ---- | ------ | ------------------ |
| "EC" | `uint8`  | 错误码                |
| "ED" | `string, UTF-8`, optional | 可选的错误描述文本          |

#### 错误码定义（EC）：

| 值    | 名称                    | 说明                       |
| ---- | --------------------- | ------------------------ |
| 0x01 | corrupt             | 数据包损坏，CRC 或结构异常，建议重传     |
| 0x02 | unexpected response | 无匹配请求编号的响应包，或响应类型错误，建议丢弃 |
| 0xFF | unknown error       | 未分类的异常情况                 |

## 应用层

应用层协议定义“请求”“响应”中的“数据”部分的具体内容。

主机到从机发送的请求数据包，其数据部分必须包含如下字段：

| Tag  | 类型       | 说明            |
| ---- | -------- | ------------- |
| "IN" | `char\[4]` | 指令标识字符串（4 字节） |

从机到主机发送的响应数据包，其数据部分必须包含如下字段：

| Tag  | 类型       | 说明               |
| ---- | -------- | ---------------- |
| "IN" | `char\[4]` | 响应对应的指令标识        |
| "ST" | `uint8`    | 执行状态码：0=成功，非0=失败 |

### 状态码定义（ST）

| 值    | 名称                | 说明                   |
| ---- | ----------------- | -------------------- |
| 0x00 | OK                | 成功                   |
| 0x01 | INVALID\_PARAM    | 参数非法，例如温度范围错误、时间戳非法等 |
| 0x02 | NOT\_INITIALIZED | 未初始化 |
| 0x03 | SENSOR\_ERROR     | 温度传感器异常              |
| 0x04 | STORAGE\_ERROR    | 存储操作失败 |
| 0xFF | INTERNAL\_ERROR   | 未知错误或异常              |

### 指令列表

| 指令名        | IN 字段  | 描述        |
| ---------- | ------ | --------- |
| Ping       | "ping" | 测试连接、时延   |
| GetTemp    | "temp" | 获取当前温度    |
| GetRTCDate | "gdat" | 获取 RTC 日期 |
| GetRTCTime | "gtim" | 获取 RTC 时间 |
| SetRTCDate | "sdat" | 设置 RTC 日期 |
| SetRTCTime | "stim" | 设置 RTC 时间 |
| GetAlarms  | "galm" | 获取报警配置    |
| SetAlarms  | "salm" | 设置报警配置    |
| GetLog    | "glog" | 获取温度记录日志  |


#### Ping（"ping"）

##### 请求

| Tag  | 类型       | 说明           |
| ---- | -------- | ------------ |
| "IN" | `char\[4]` | 固定为 "ping" |

##### 响应

| Tag   | 类型       | 说明           |
| ----- | -------- | ------------ |
| "IN"  | `char\[4]` | 固定为 "ping" |
| "ST"  | `uint8`    | 状态码，固定为 `0x00`   |


#### GetTemp（"temp"）

##### 请求

| Tag  | 类型       | 说明           |
| ---- | -------- | ------------ |
| "IN" | `char\[4]` | 固定为 "temp" |

##### 响应

| Tag  | 类型       | 说明           |
| ---- | -------- | ------------ |
| "IN" | `char\[4]` | 固定为 "temp" |
| "ST" | `uint8`    | 状态码          |
| "T " | float32  | 当前温度（${}^\circ{}\text{C}$）      |

- 可能错误：
    - `SENSOR_ERROR`：DS18B20 无法读取数据

#### GetRTCDate（"gdat"）

##### 请求

| Tag  | 类型       | 说明           |
| ---- | -------- | ------------ |
| "IN" | `char\[4]` | 固定为 "gdat" |

##### 响应

| Tag  | 类型       | 说明           |
| ---- | -------- | ------------ |
| "IN" | `char\[4]` | 固定为 "gdat" |
| "ST" | `uint8`    | 状态码           |
| "YY" | `uint8`   | 年（0 - 99）   |
| "MM" | `uint8`   | 月（1 - 12）   |
| "DD" | `uint8`   | 日（1 - 31）  |
| "WK" | `uint8`   | 星期几（1 - 7）   |

- 可能错误
    - `NOT_INITIALIZED`：RTC 未初始化或无法读取时间

#### GetRTCTime（"gtim"）

##### 请求

| Tag  | 类型       | 说明           |
| ---- | -------- | ------------ |
| "IN" | `char\[4]` | 固定为 "gtim" |

##### 响应

| Tag  | 类型       | 说明           |
| ---- | -------- | ------------ |
| "IN" | `char\[4]` | 固定为 "gtim" |
| "ST" | `uint8`    | 状态码           |
| "HH" | `uint8`   | 时（0 - 23）   |
| "MM" | `uint8`   | 分（0 - 60）   |
| "SS" | `uint8`   | 秒（0 - 60）  |

- 可能错误
    - `NOT_INITIALIZED`：RTC 未初始化或无法读取时间

#### SetRTCDate（"sdat"）

##### 请求

| Tag  | 类型       | 说明              |
| ---- | -------- | --------------- |
| "IN" | `char\[4]` | 固定为 "sdat"    |
| "YY" | `uint8`   | 年（0 - 99）     |
| "MM" | `uint8`   | 月（1 - 12）     |
| "DD" | `uint8`   | 日（1 - 31）    |
| "WK" | `uint8`   | 星期几（1 - 7） |

##### 响应

| Tag  | 类型       | 说明           |
| ---- | -------- | ------------ |
| "IN" | `char\[4]` | 固定为 "sdat" |
| "ST" | `uint8`    | 状态码           |

- 可能错误
    - `INVALID_PARAM`：日期格式错误或不合法
    - `NOT_INITIALIZED`：RTC 未初始化或无法写入时间

#### SetRTCTime（"stim"）

##### 请求

| Tag  | 类型       | 说明              |
| ---- | -------- | --------------- |
| "IN" | `char\[4]` | 固定为 "stim"    |
| "HH" | `uint8`   | 时（0 - 23）     |
| "MM" | `uint8`   | 分（0 - 60）     |
| "SS" | `uint8`   | 秒（0 - 60）    |

##### 响应

| Tag  | 类型       | 说明           |
| ---- | -------- | ------------ |
| "IN" | `char\[4]` | 固定为 "stim" |
| "ST" | `uint8`    | 状态码           |

- 可能错误
    - `INVALID_PARAM`：时间格式错误或不合法
    - `NOT_INITIALIZED`：RTC 未初始化或无法写入时间

#### GetAlarms（"galm"）

##### 请求

| Tag  | 类型       | 说明           |
| ---- | -------- | ------------ |
| "IN" | `char\[4]` | 固定为 "galm" |

##### 响应

| Tag  | 类型       | 说明             |
| ---- | -------- | -------------- |
| "IN" | `char\[4]` | 固定为 "galm"   |
| "ST" | `uint8`    | 状态码           |
| "AL" | `TLV\[]`   | 报警配置数组，见下方嵌套结构 |

###### 嵌套结构（AL 内部）：

| Tag  | 类型      | 说明                   |
| ---- | ------- | -------------------- |
| "ID" | `uint8`   | 报警通道 ID（0=蜂鸣器，1=LED） |
| "L"  | `float32` | 下限温度                 |
| "H"  | `float32` | 上限温度                 |


#### SetAlarms（"salm"）

##### 请求

| Tag  | 类型       | 说明           |
| ---- | -------- | ------------ |
| "IN" | `char\[4]` | 固定为 "salm" |
| "AL" | `TLV\[]`   | 报警配置数组，结构同上  |

##### 响应

| Tag  | 类型       | 说明           |
| ---- | -------- | ------------ |
| "IN" | `char\[4]` | 固定为 "salm" |
| "ST" | `uint8`    | 状态码           |


#### GetLog（"glog"）

##### 请求

| Tag   | 类型       | 说明           |
| ----- | -------- | ------------ |
| "IN"  | `char\[4]` | 固定为 "glog" |
| "TS1" | `uint64`   | 起始时间戳（秒）     |
| "TS2" | `uint64`   | 结束时间戳（秒）     |
| "MX"  | `uint16`   | 最多返回条数（可选）   |

##### 响应

| Tag  | 类型       | 说明             |
| ---- | -------- | -------------- |
| "IN" | `char\[4]` | 固定为 "glog"   |
| "ST" | `uint8`    | 状态码           |
| "LG" | `TLV\[]`   | 日志条目数组，见下方嵌套结构 |

###### 嵌套结构（LG 内部）：

| Tag  | 类型      | 说明     |
| ---- | ------- | ------ |
| "TS" | `uint64`  | 时间戳（秒） |
| "T " | `float32` | 温度值（${}^\circ{}\text{C}$） |
