# STM32温度测量仪器系统

这是一个基于STM32F103ZET6的智能温度测量仪器，支持通过蓝牙(UART)进行远程控制和数据读取。

## 功能特性

### 硬件功能
- **DS18B20温度传感器**：精确测量环境温度
- **LED指示灯**：通过PWM控制亮度，用于状态指示和报警
- **蜂鸣器**：通过PWM控制，用于声音报警
- **RTC实时时钟**：提供准确的时间基准
- **蓝牙通信**：通过UART1进行数据传输

### 软件功能
- **温度监控**：实时读取DS18B20温度数据
- **报警系统**：温度超限时触发LED和蜂鸣器报警
- **数据记录**：自动记录温度日志，支持历史查询
- **远程控制**：通过蓝牙接收控制命令
- **时间管理**：RTC时间设置和获取

## 通信协议

系统采用自定义的TLV（Tag-Length-Value）通信协议，支持以下指令：

### 基础指令
- `ping` - 连接测试
- `temp` - 获取当前温度
- `gdat`/`sdat` - 获取/设置RTC日期
- `gtim`/`stim` - 获取/设置RTC时间

### 控制指令
- `sled`/`rled` - 设置/重置LED状态
- `sbzr`/`rbzr` - 设置/重置蜂鸣器状态
- `galm`/`salm` - 获取/设置报警配置

### 数据指令
- `glog` - 获取温度历史日志

## 硬件连接

### GPIO配置
- **PG11** - DS18B20数据线（开漏输出）
- **PB8** - PWM输出（TIM4_CH3）用于LED和蜂鸣器控制
- **PA9/PA10** - UART1 TX/RX（蓝牙通信）

### 按键配置
- **PA0** - KEY0（上拉）
- **PE2** - KEY3_N
- **PE3** - KEY2_N  
- **PE4** - KEY1_N

## 编译和使用

### 编译环境
- CMake 3.22+
- ARM GCC工具链
- STM32CubeMX生成的HAL库

### 编译步骤
```bash
cd mcu
mkdir -p build
cd build
cmake ..
make -j4
```

### 烧录
生成的文件位于`build/temperature_measure.hex`，可使用ST-Link等工具烧录到STM32。

## 系统架构

### 软件模块
1. **protocol.c/h** - 通信协议实现
2. **device_control.c/h** - 设备控制接口
3. **command_handler.c/h** - 命令处理逻辑
4. **communication.c/h** - 通信管理模块
5. **DS18B20.c/h** - 温度传感器驱动

### 实时操作系统
- 使用FreeRTOS进行任务调度
- 主任务处理通信和设备控制
- 支持中断驱动的UART DMA传输

## 通信协议详细说明

详细的通信协议规范请参考 `docs/common/communication.md` 文件。

协议特点：
- 二进制TLV格式，支持嵌套
- 硬件CRC32校验确保数据完整性
- 转义机制防止数据冲突
- 支持请求-响应和错误处理

## 注意事项

1. **电源要求**：系统需要3.3V供电
2. **时钟配置**：使用外部8MHz晶振，PLL倍频到72MHz
3. **温度传感器**：DS18B20需要4.7kΩ上拉电阻
4. **蓝牙模块**：需要配置为透传模式，波特率115200

## 扩展功能

系统设计具有良好的扩展性，可以添加：
- 更多传感器接口
- LCD显示屏支持
- SD卡数据存储
- 以太网通信
- Web服务器功能

## 许可证

本项目基于MIT许可证开源。
